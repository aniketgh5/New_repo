trigger:
  branches:
    include:
      - main
  paths:
    include:
      - appa/**
      - appb/**
      - appc/**
      - azure-pipelines.yml

pr: none

pool: kolkata

# -------------------------------------------------
# PARAMETERS
# -------------------------------------------------
parameters:
  - name: deployMode
    displayName: Deployment Mode
    type: string
    default: auto
    values:
      - auto
      - manual

  - name: applications
    displayName: Applications (Manual Mode)
    type: object
    default:
      - appa
      - appb
      - appc

  - name: imageTag
    displayName: Docker Image Tag
    type: string
    default: latest

# -------------------------------------------------
# VARIABLES
# -------------------------------------------------
variables:
  - group: "New variable group 14-Jan"

# =================================================
# STAGE 1: DETECT
# =================================================
stages:
- stage: Detect
  displayName: Detect Applications to Build
  jobs:
  - job: DetectApps
    displayName: Resolve Changed Applications
    steps:
    - checkout: self
      fetchDepth: 2
      displayName: Checkout Repository

    - bash: |
        echo "Deployment Mode: ${{ parameters.deployMode }}"
        COMPONENTS=""

        if [ "${{ parameters.deployMode }}" = "auto" ]; then
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || true)
          echo "$CHANGED_FILES"

          for app in appa appb appc
          do
            if echo "$CHANGED_FILES" | grep -q "^$app/"; then
              COMPONENTS="$COMPONENTS $app"
            fi
          done

          if [ -z "$COMPONENTS" ]; then
            echo "No changes detected. Defaulting to full build."
            COMPONENTS="appa appb appc"
          fi
        else
          COMPONENTS="${{ join(' ', parameters.applications) }}"
        fi

        echo "Final components: $COMPONENTS"
        echo "##vso[task.setvariable variable=components;isOutput=true]$COMPONENTS"
      name: detect
      displayName: Detect Components

# =================================================
# STAGE 2: BUILD
# =================================================
- stage: Build
  displayName: Build and Push Docker Images
  dependsOn: Detect
  variables:
    components: $[ stageDependencies.Detect.DetectApps.outputs['detect.components'] ]
  jobs:
  - job: BuildImages
    displayName: Docker Build and Push
    steps:
    - checkout: self
      displayName: Checkout Repository

    - task: AzureCLI@2
      displayName: Build and Push Images to ACR
      inputs:
        azureSubscription: aniket_account
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          az acr login --name $(acrName)

          for component in $(components); do
            case $component in
              appa) image="us11image" ;;
              appb) image="us12image" ;;
              appc) image="us13image" ;;
            esac

            echo "Building image for $component"
            docker build \
              -t $(acrLoginServer)/$image:${{ parameters.imageTag }} \
              ./$component

            echo "Pushing image for $component"
            docker push $(acrLoginServer)/$image:${{ parameters.imageTag }}
          done

# =================================================
# STAGE 3: DEPLOY
# =================================================
- stage: Deploy
  displayName: Deploy to Azure App Services
  dependsOn: Build
  variables:
    components: $[ stageDependencies.Detect.DetectApps.outputs['detect.components'] ]
  jobs:
  - job: DeployApps
    displayName: Deploy Containers
    steps:
    - task: AzureCLI@2
      displayName: Deploy Images to App Services
      inputs:
        azureSubscription: aniket_account
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e

          for component in $(components); do
            case $component in
              appa) image="us11image"; app="demowebapp101" ;;
              appb) image="us12image"; app="demowebapp102" ;;
              appc) image="us13image"; app="demowebapp103" ;;
            esac

            echo "Deploying $component to $app"

            az webapp config container set \
              --name $app \
              --resource-group $(resourceGroup) \
              --docker-custom-image-name $(acrLoginServer)/$image:${{ parameters.imageTag }} \
              --docker-registry-server-url https://$(acrLoginServer)

            az webapp restart \
              --name $app \
              --resource-group $(resourceGroup)
          done
