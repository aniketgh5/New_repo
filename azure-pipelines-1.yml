trigger:
  branches:
    include:
      - main/*
      - feature/*
  paths:
    include:
      - appa/**
      - appb/**
      - appc/**
      - azure-pipelines.yml

pr: none

pool: kolkata

# -------------------------------------------------
# PARAMETERS
# -------------------------------------------------
parameters:
  - name: deployMode
    displayName: Deployment Mode
    type: string
    default: auto
    values:
      - auto
      - manual

  - name: applications
    displayName: Applications (Manual Mode)
    type: object
    default:
      - appa
      - appb
      - appc

  - name: imageTag
    displayName: Docker Image Tag
    type: string
    default: latest

# -------------------------------------------------
# VARIABLES
# -------------------------------------------------
variables:
  - group: "New variable group 14-Jan"

# -------------------------------------------------
# STAGE
# -------------------------------------------------
stages:
- stage: Build_And_Deploy
  displayName: Build and Deploy Flask Applications
  jobs:
  - job: BuildDeploy
    displayName: Build, Push, and Deploy Containers
    steps:

    # -------------------------
    # CHECKOUT
    # -------------------------
    - checkout: self
      fetchDepth: 2
      displayName: Checkout Repository

    # -------------------------
    # DETERMINE COMPONENTS
    # -------------------------
    - bash: |
        echo "Deployment Mode: ${{ parameters.deployMode }}"
        COMPONENTS=""

        if [ "${{ parameters.deployMode }}" = "auto" ]; then
          echo "Detecting changed folders..."
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || true)
          echo "$CHANGED_FILES"

          for app in appa appb appc
          do
            if echo "$CHANGED_FILES" | grep -q "^$app/"; then
              COMPONENTS="$COMPONENTS $app"
            fi
          done

          # FIRST RUN / NO DIFF SAFETY
          if [ -z "$COMPONENTS" ]; then
            echo "No changes detected. Running full build (first-run safety)."
            COMPONENTS="appa appb appc"
          fi
        else
          COMPONENTS="${{ join(' ', parameters.applications) }}"
        fi

        echo "Final components list: $COMPONENTS"
        echo "##vso[task.setvariable variable=components]$COMPONENTS"
      displayName: Resolve Applications to Build

    # -------------------------
    # BUILD & PUSH TO ACR
    # -------------------------
    - task: AzureCLI@2
      displayName: Build and Push Docker Images to Azure Container Registry
      inputs:
        azureSubscription: aniket_account
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e
          az acr login --name $(acrName)

          for component in $(components); do

            case $component in
              appa) image="us11image" ;;
              appb) image="us12image" ;;
              appc) image="us13image" ;;
            esac

            echo "Building image for $component"
            docker build \
              -t $(acrLoginServer)/$image:${{ parameters.imageTag }} \
              ./$component

            echo "Pushing image for $component"
            docker push $(acrLoginServer)/$image:${{ parameters.imageTag }}

          done

    # -------------------------
    # DEPLOY TO APP SERVICES
    # -------------------------
    - task: AzureCLI@2
      displayName: Deploy Containers to Azure App Services
      inputs:
        azureSubscription: aniket_account
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e

          for component in $(components); do

            case $component in
              appa) image="us11image"; app="demowebapp101" ;;
              appb) image="us12image"; app="demowebapp102" ;;
              appc) image="us13image"; app="demowebapp103" ;;
            esac

            echo "Deploying $component to $app"

            az webapp config container set \
              --name $app \
              --resource-group $(resourceGroup) \
              --docker-custom-image-name $(acrLoginServer)/$image:${{ parameters.imageTag }} \
              --docker-registry-server-url https://$(acrLoginServer)

            az webapp restart \
              --name $app \
              --resource-group $(resourceGroup)

          done
